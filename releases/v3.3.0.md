# LeadCMS SDK v3.3.0 - Three-Way Content Merging & Scoped Reset

We're excited to announce **LeadCMS SDK v3.3.0**, featuring **automatic three-way merging** during `leadcms pull`. Local changes are now preserved and merged with remote updates â€” just like `git merge` â€” instead of being silently overwritten.

## ðŸŒŸ What's New

### ðŸ”€ Three-Way Content Merging

`leadcms pull` now detects locally modified files and **merges** them with remote changes instead of overwriting. This is powered by a server-side base snapshot (via the existing sync token mechanism) â€” no extra local storage or `.gitignore` changes needed.

> **Requires LeadCMS v1.3.18-pre or above.** The `includeBase` parameter was introduced in LeadCMS v1.3.18-pre. On older server versions, pull continues to work as before (overwrite without merge).

**How it works:**

1. On incremental sync, the SDK sends `includeBase=true` to the sync API
2. The server returns `baseItems` â€” the content as it was at your last sync
3. The SDK compares your local file against the base to detect local edits
4. If both sides changed, a three-way merge is performed automatically
5. Only truly overlapping changes produce conflict markers

**Merge strategies by content type:**

| Format                    | Strategy                     | Why                                         |
| ------------------------- | ---------------------------- | ------------------------------------------- |
| **JSON** (components)     | Structural field-level merge | Avoids false conflicts from adjacent fields |
| **MDX** (articles, pages) | Line-based diff3 merge       | Works naturally with frontmatter + body     |

**Example â€” auto-merge without conflicts:**

```
# Base (last sync)          # Local edit              # Remote edit
title: My Post              title: My Post            title: My Post
description: Original       description: My desc  â†   description: Original
author: John                author: John              author: Jane  â†
```

Result: both `description` and `author` changes are merged automatically.

**Example â€” true conflict (manual resolution needed):**

```
# Local                     # Remote
title: Local Title          title: Remote Title   â† both changed same field
```

Result: conflict markers are inserted for manual resolution, just like git.

### ðŸ›¡ï¸ Server-Controlled Field Handling

Fields managed by the server (`updatedAt`, `createdAt`) are **always auto-resolved to the remote value** during merge â€” in both JSON and MDX content. This eliminates false conflicts caused by:

- **Timestamp precision mismatches** (server returns 7 decimal places, local file has 6)
- **Server updating `updatedAt`** on every save while local file retains the old value

These fields never produce conflict markers regardless of local/remote differences.

### ðŸŽ¯ Scoped `--reset` for Individual Pull Commands

The `--reset` flag now works on individual pull commands, not just `leadcms pull`:

```bash
# Reset everything (existing behavior)
leadcms pull --reset

# Reset only content â€” media and comments are untouched
leadcms pull-content --reset

# Reset only media â€” content and comments are untouched
leadcms pull-media --reset

# Reset only comments â€” content and media are untouched
leadcms pull-comments --reset
```

Each scoped reset deletes only the relevant directory and its sync token (including legacy token locations from SDK â‰¤ 3.2), then performs a fresh pull.

## ðŸ› Bug Fixes

### Fixed: `leadcms generate-env` command not working

The `generate-env` command was broken due to a CommonJS guard (`require.main === module`) that never evaluates to `true` in the SDK's ESM module system. The script now exports a proper `generateEnv()` function called from the CLI entry point, matching the pattern used by all other commands.

## ðŸ“Š Test Coverage

- **568 tests** across 25 test suites (up from 525 in v3.2.0)
- New test suites: `content-merge.test.ts`, `content-merge-realworld.test.ts`
- Expanded: `pull-reset.test.ts` (18 â†’ 32 tests), `generate-env.test.ts` (10 â†’ 14 tests)

## ðŸ”§ Dependencies

- Added: `node-diff3` v3.2.0 â€” three-way merge algorithm

## â¬†ï¸ Upgrade Guide

This is a **non-breaking** minor release. Update with:

```bash
npm install @leadcms/sdk@3.3.0
# or
pnpm add @leadcms/sdk@3.3.0
```

No code changes required. Existing `leadcms pull` workflows will automatically benefit from three-way merging on the next incremental sync. Full pulls (first-time or `--reset`) work as before.

> **Server requirement:** Three-way merging requires **LeadCMS v1.3.18-pre or above**. With older server versions, pull continues to work as before (remote overwrites local).
