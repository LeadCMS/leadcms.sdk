# LeadCMS SDK v2.2.0 - Enhanced Authentication & Improved Initialization

We're excited to announce **LeadCMS SDK v2.2.0**, featuring a major authentication overhaul with device authentication support, improved initialization flow, and better developer experience!

## ğŸŒŸ What's New

### ğŸ” Device Authentication Flow (OAuth-like)

LeadCMS SDK now supports modern device authentication for seamless login without manual token extraction!

**Key Features:**
- **Automatic Version Detection** - SDK checks your LeadCMS instance version and uses the best authentication method
- **Device Authentication** - For LeadCMS v1.2.88+ with browser-based approval flow
- **Legacy Support** - Automatic fallback to manual token flow for older versions
- **Smart Version Comparison** - Supports semantic versioning with pre-release tags

**Device Authentication Flow:**
```bash
$ npx leadcms login

ğŸ” Checking LeadCMS version...
   Version: 1.2.88-pre

ğŸ” Starting device authentication...

ğŸ“‹ To complete authentication, open this link in your browser:

   https://your-instance.com/identity/device?userCode=ABCD-1234

â±ï¸  Code expires in 15 minutes
â³ Waiting for authorization...

âœ… Authentication successful!
   Logged in as: John Doe
```

**For Older Versions:**
- Automatically falls back to manual token extraction
- Clear step-by-step instructions
- Version requirement messaging

### ğŸš€ Integrated Authentication in Init Flow

Authentication is now seamlessly integrated into the initialization process!

**New Init Flow:**
```bash
$ npx leadcms init

ğŸš€ LeadCMS SDK Initialization

Enter your LeadCMS URL [http://localhost:45437]: â† Press Enter to keep existing

ğŸ” Authentication Setup
   Authentication is optional and can be skipped for most use cases.
   â€¢ Without authentication: You can pull content and build your site (read-only access)
   â€¢ With authentication: You can also push content changes back to LeadCMS
   â€¢ You can always authenticate later by running: leadcms login

Would you like to authenticate now? (Y/n): y

ğŸ” Checking LeadCMS version...
âœ… Authentication successful!
```

**Benefits:**
- âœ… Single command setup (no separate `leadcms login` needed)
- âœ… Clear explanation of authentication benefits
- âœ… Optional - can skip for read-only access
- âœ… Graceful error handling with fallback to read-only mode

### ğŸ“ Smarter Configuration Management

The init command now intelligently reads and reuses existing configuration values!

**Improvements:**
- **Existing Value Detection** - Reads from `.env`, `.env.local`, and `leadcms.config.json`
- **Smart Defaults** - Shows existing values in prompts with `[current-value]` format
- **Press Enter to Keep** - Easy to reuse existing configuration
- **Conditional Messaging** - Only shows "No API key found" if `.env` file exists

**Example with Existing Config:**
```bash
$ npx leadcms init

âš ï¸  Configuration files already exist. Overwrite? (y/N): y

Enter your LeadCMS URL [https://my-instance.leadcms.ai]: â† Press Enter
Default language code [en-US]: â† Press Enter
Content directory [.leadcms/content]: â† Press Enter
```

### ğŸŒ Language Selection Confirmation

Even when fetching language configuration from the API, you can now confirm or change the default language!

**New Flow:**
```bash
âœ… Connected successfully!

ğŸ“‹ Available languages:
   1. English [en-US] (default)
   2. Spanish [es-ES]
   3. French [fr-FR]

Default language code [en-US]: â† Press Enter to accept or type another code

âœ“ Using default language: en-US
```

**Benefits:**
- See all available languages from your LeadCMS instance
- Confirm the suggested default language
- Override with a different language if needed
- Better visibility of multi-language setup

### ğŸ’¬ Comments Support & Selective Pulling

Full support for LeadCMS comments with dedicated CLI commands for selective content pulling!

**New CLI Commands:**
```bash
# Pull only content files (MDX/JSON)
npx leadcms pull-content

# Pull only comments
npx leadcms pull-comments

# Pull only media files
npx leadcms pull-media

# Pull everything (default)
npx leadcms pull
```

**Comments API:**
```typescript
import { 
  getComments,                    // Get comments for any entity
  getCommentsForContent,          // Get comments for specific content
  getCommentsTree,                // Get hierarchical comment tree
  getCommentsTreeForContent       // Get comment tree for content
} from '@leadcms/sdk';

// Fetch comments for a blog post
const comments = await getCommentsForContent('my-article', 'blog-post');

// Get comments as a tree structure (with replies)
const commentTree = await getCommentsTreeForContent('my-article', 'blog-post', {
  sortBy: 'date',
  sortOrder: 'desc'
});
```

**Benefits:**
- **Selective Pulling** - Only sync what you need (faster builds)
- **Comments Integration** - Full support for comment threads
- **Tree Structure** - Hierarchical comments with parent-child relationships
- **Flexible API** - Multiple functions for different use cases

## ğŸ”§ Technical Improvements

### New Authentication Library (`src/lib/auth.ts`)

Extracted authentication logic into a reusable module:

**Exported Functions:**
```typescript
import { 
  authenticate,           // Complete auth flow with version detection
  deviceAuthFlow,        // Device authentication (OAuth-like)
  manualTokenFlow,       // Manual token extraction (legacy)
  verifyToken,           // Verify API token
  saveTokenToEnv,        // Save token to .env file
  getLeadCMSVersion,     // Get instance version
  compareVersions,       // Semver comparison
  supportsDeviceAuth     // Check device auth support
} from '@leadcms/sdk';
```

**Key Features:**
- Framework-agnostic design with dependency injection
- Automatic version detection and flow selection
- Supports LeadCMS >= 1.2.88 (device auth) and older versions (manual)
- Can be used programmatically in custom integrations

### Refactored Scripts

**Login Script** (`login-leadcms.ts`):
- Reduced from ~355 lines to ~67 lines
- Uses shared authentication module
- Cleaner, more maintainable code

**Init Script** (`init-leadcms.ts`):
- Added `readExistingConfig()` function
- Integrated authentication flow
- Better error handling and user messaging
- Smarter default value management

### Better User Experience

**Improved Messaging:**
- âœ… Clear authentication explanations
- âœ… Contextual prompts (only show "No API key" if `.env` exists)
- âœ… Helpful next steps after configuration
- âœ… Graceful error handling with recovery options

**Enhanced CLI Output:**
- ğŸ” Authentication Setup section with clear benefits
- ğŸ“‹ Visual language list with default markers
- âœ“ Success confirmations for each step
- âš ï¸ Clear error messages with recovery instructions

## ğŸ¯ Use Cases

### First-Time Setup (New Project)
```bash
# Single command to set everything up
npx leadcms init

# SDK handles:
# - URL configuration
# - Authentication (optional)
# - Language selection
# - Directory setup

# Start using immediately
npx leadcms pull
```

### Re-initialization (Existing Project)
```bash
# Keep existing values with one command
npx leadcms init

# Press Enter on each prompt to keep existing:
# - URL: [https://your-instance.com] âœ“
# - Language: [en-US] âœ“
# - Directories: [.leadcms/content] âœ“
```

### Authentication Only
```bash
# Standalone authentication command still available
npx leadcms login

# Automatic device auth for supported versions
# Manual fallback for older versions
```

### Selective Content Pulling
```bash
# Pull only content (no comments or media)
npx leadcms pull-content

# Pull only comments
npx leadcms pull-comments

# Pull only media files
npx leadcms pull-media

# Pull everything (default behavior)
npx leadcms pull
```

## ğŸ”„ Migration Guide

### From v2.1.x to v2.2.0

**No Breaking Changes!** This is a minor version with backward compatibility.

**New Features Available:**
1. **Device Authentication** - Works automatically if your LeadCMS instance supports it (v1.2.88+)
2. **Integrated Init Flow** - Can now authenticate during initialization
3. **Authentication Library** - Can import auth functions for custom use

**Existing Workflows Still Work:**
```bash
# Old workflow (still works)
npx leadcms init
npx leadcms login
npx leadcms pull

# New workflow (streamlined)
npx leadcms init  # Now includes authentication
npx leadcms pull
```

**Config Files Unchanged:**
- `.env` file format remains the same
- `leadcms.config.json` format unchanged
- All existing configurations work as before

## ğŸ“Š Test Coverage

- **261 tests passing** (no regressions)
- **66.66% code coverage** (+2.67% from v2.1.x)
- **New test suites:**
  - `cms-config-types.test.ts` - 20 tests (88% coverage)
  - `config.test.ts` - 14 tests (78.94% coverage)
- **All Node.js versions tested:** 18, 20, 22

## ğŸ—‚ï¸ New Files & Features

### Added
- `src/lib/auth.ts` - Shared authentication library
- `docs/AUTH_INTEGRATION.md` - Implementation documentation
- `releases/v2.2.0.md` - This release notes file
- **Comments support** - Full API for fetching and managing comments
- **CLI commands** - `pull-content`, `pull-comments`, `pull-media` for selective pulling

### Modified
- `src/scripts/login-leadcms.ts` - Refactored to use auth library
- `src/scripts/init-leadcms.ts` - Integrated authentication and improved UX
- `src/index.ts` - Exported auth module and comments API for public use
- `src/cli/index.ts` - Added new selective pulling commands

## ğŸ› Bug Fixes

- **Fixed:** Init flow now always prompts for URL even with existing config
- **Fixed:** Conditional "No API key found" message only shown when `.env` exists
- **Fixed:** Better handling of empty folders vs existing configurations
- **Fixed:** Default language confirmation added for API-fetched configurations

## ğŸ“– Documentation Updates

- Added authentication API reference to main exports
- Updated CLI command documentation
- Added device authentication examples
- Improved Quick Start guide in README
- Added implementation details in `AUTH_INTEGRATION.md`

## ğŸ”’ Security

- API keys stored securely in `.env` files (not in version control)
- Device authentication uses standard OAuth-like flow
- Token verification before saving
- No sensitive data in error messages

## ğŸ›£ï¸ What's Next

Future releases will focus on:
- Enhanced test coverage (target 80%+)
- Real-time content synchronization improvements
- Additional authentication providers
- Plugin system for custom transformations
- Advanced caching strategies

## ğŸ™ Feedback Welcome

We'd love to hear your feedback on the new authentication flow and initialization improvements!

- **GitHub Issues**: [Report bugs or request features](https://github.com/LeadCMS/leadcms.sdk/issues)
- **Discussions**: Share your use cases and suggestions
- **Pull Requests**: Contributions welcome!

---

## ğŸ“¦ Installation

### Upgrade from v2.1.x
```bash
npm install @leadcms/sdk@latest
# or
yarn upgrade @leadcms/sdk@latest
# or
pnpm update @leadcms/sdk@latest
```

### Fresh Installation
```bash
npm install @leadcms/sdk
npx leadcms init
```

---

**Enjoy the improved developer experience! ğŸš€**

**Happy coding with LeadCMS SDK v2.2.0!**
