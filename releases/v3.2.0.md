# LeadCMS SDK v3.2.0 - Robust Content Sync & Comprehensive Test Coverage

**LeadCMS SDK v3.2.0** delivers significant improvements to the content synchronisation engine â€” correctly handling renamed, moved, deleted, and type-changed content and media â€” along with a new `pull --reset` command and a major expansion of the test suite.

## ğŸŒŸ What's New

### ğŸ”„ `leadcms pull --reset` â€” Fresh Pull from Scratch

A new `--reset` flag lets you wipe all local content, media, comments, and sync tokens before pulling, giving you a clean slate without manually deleting files.

```bash
# Full reset â€” removes everything locally, then pulls from the server
npx leadcms pull --reset
```

**What it clears:**

- All content files (`contentDir`)
- All media files (`mediaDir`)
- All comment files (`commentsDir`)
- Sync tokens (both new and legacy locations)

Safe to run even when no local state exists (e.g. first-time setup on a new machine).

### ğŸ—‚ï¸ Intelligent Content File Cleanup on Sync

Previously, when content was renamed (slug change), moved to a different type, or switched format (MDX â†” JSON), the old file would linger on disk alongside the new one. The sync engine now builds an **in-memory content ID index** and removes the outdated file _before_ writing the updated version.

This correctly handles:

- **Slug renames** â€” old slug file is deleted, new slug file is created
- **Content type changes** â€” e.g. `article/my-post.mdx` â†’ `page/my-post.mdx`
- **Format switches** â€” e.g. `.mdx` â†’ `.json` when the content type format changes
- **Language changes** â€” content moved between locale directories

### ğŸ—‘ï¸ Media Deletion Sync

The media sync endpoint now processes the `deleted` array returned by the server. When media files are removed from LeadCMS, those files are automatically removed from your local `mediaDir` during the next pull.

### ğŸ“ Sync Token Relocation & Legacy Migration

Sync tokens have moved from a shared `.leadcms/` parent directory into the data directories they belong to:

| Token    | Old location (SDK â‰¤ 3.1)          | New location (SDK 3.2+)   |
| -------- | --------------------------------- | ------------------------- |
| Content  | `.leadcms/sync-token.txt`         | `contentDir/.sync-token`  |
| Media    | `.leadcms/media-sync-token.txt`   | `mediaDir/.sync-token`    |
| Comments | `.leadcms/comment-sync-token.txt` | `commentsDir/.sync-token` |

**Automatic migration:** On the first pull after upgrading, the SDK reads the legacy token, uses it for the sync request, writes the new token to the new location, and deletes the legacy file. No manual action required.

### ğŸ“Š Improved Content Comparison

The `transformToMDXFormatForComparison` and `transformToJSONFormatForComparison` functions now include **all** non-system remote fields when generating the comparison string, rather than filtering to only fields present locally. This means:

- **Field removals** in local content are correctly detected as changes during `leadcms status`
- **False positives** from server-added fields are still prevented by the timestamp-based conflict check

## ğŸ§ª Test Coverage

Test coverage has been substantially expanded â€” from **393 tests across 23 suites** to **481 tests across 30 suites**.

### New Test Suites

| Suite                          | Description                                                 |
| ------------------------------ | ----------------------------------------------------------- |
| `pull-reset.test.ts`           | `--reset` flag, sync token locations, legacy migration      |
| `pull-sync-edge-cases.test.ts` | Slug renames, type changes, pagination, empty syncs         |
| `pull-slug-rename.test.ts`     | Content slug rename during sync                             |
| `fetch-content.test.ts`        | Content ID index, file deletion by ID, ID extraction        |
| `push-scripts.test.ts`         | Push script orchestration and error handling                |
| `helpers-media.test.ts`        | Media URL extraction and download helpers                   |
| `generate-env.test.ts`         | Environment JS file generation                              |
| `init-leadcms.test.ts`         | Interactive init flow                                       |
| `test-helpers.ts`              | Shared sync test harness used across pull integration tests |

### Improved Test Suites

- **`push.test.ts`** â€” expanded coverage for push operations
- **`status.test.ts`** â€” comprehensive status comparison scenarios
- **`comments.test.ts`** â€” additional comment sync edge cases
- **`login.test.ts`** â€” refactored auth tests (replaces removed `auth.test.ts`)
- **`push-json-content.test.ts`** â€” more JSON content push scenarios

## ğŸ”§ Other Changes

- Removed unused `extractMediaUrlsFromContent` import from content fetch
- Removed unused `CommentsByEntity` type import from comments fetch
- Removed unused `SYSTEM_FIELDS` and `USER_CONTENT_FIELDS` exports from content transformation
- Cleaned up unused code in `cms.ts`, `leadcms-helpers.ts`, `push-leadcms-content.ts`, and `sse-watcher.ts`
- Updated `swagger.json` with the latest LeadCMS API specification
- Improved README formatting for better readability

---

## ğŸ“¦ Upgrade Guide

```bash
npm install @leadcms/sdk@3.2.0
# or
pnpm add @leadcms/sdk@3.2.0
```

No breaking changes. Sync token migration happens automatically on the first pull.

If you encounter any stale local files from previous syncs, run:

```bash
npx leadcms pull --reset
```

---

**Happy coding with LeadCMS SDK v3.2.0! ğŸš€**

_For questions, issues, or feedback, visit our [GitHub repository](https://github.com/LeadCMS/leadcms.sdk)._
